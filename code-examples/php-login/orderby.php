<?php
// you can't use prepared statements for order by 
// https://www.nccgroup.com/us/about-us/newsroom-and-events/blog/2019/march/did-you-order-a-sql-injection/

include("config.php");

if(! isset($_GET["order_by"])) {
   echo "no order_by supplied";
   exit;
}
$order_by = $_GET['order_by'];

## BEGIN #1  PREPARED STATEMENT
// Problem described here: https://stackoverflow.com/questions/40442344/handling-order-by-and-order-type-parameters-in-prepared-statements
echo "prepared statement (MySQL does not support prepared prepared statements for table names)<br><br>";
  
$mysqli = new mysqli(DB_SERVER, DB_USERNAME, DB_PASSWORD, DB_DATABASE);

if ($mysqli->connect_errno) {
    echo "Failed to connect to MySQL: (" . $mysqli->connect_errno . ") " . $mysqli->connect_error;
}

//if (!($stmt = $mysqli->prepare("SELECT id, username FROM login where username = ?"))) {
// user input 1 => prepared statement makes '1' out of it => sorting functionality does not work. But it's safe!
// if you want to have a working sorting functionality of the db you have to use string concatenation and whitelist the user input before
if (!($stmt = $mysqli->prepare("SELECT id, username FROM login ORDER BY ?"))) {
    echo "Prepare failed: (" . $mysqli->errno . ") " . $mysqli->error;
}

if (!$stmt->bind_param("s", $order_by)) {
    echo "Binding parameters failed: (" . $stmt->errno . ") " . $stmt->error;
}

if (!$stmt->execute()) {
    echo "Execute failed: (" . $stmt->errno . ") " . $stmt->error;
}

$result = $stmt->get_result();
while ($row = $result->fetch_assoc()) {
    echo $row['id'] . " " . $row['username'] . "<br>\n";
}

## END #1 PREPARED STATEMENT


## BEGIN #2  mysqli_real_escape_string
  echo "<br>mysqli_real_escape_string<br><br>";

  //$sql = "SELECT id, username FROM login where username = '" . mysqli_real_escape_string($mysqli, $order_by) . "'"; 
  echo mysqli_real_escape_string($mysqli, $order_by) . "<br>";
  $sql = "SELECT id, username FROM login ORDER BY " . mysqli_real_escape_string($mysqli, $order_by); # this is not save because we don't need a ' to escape
  $result = mysqli_query($db,$sql) or die(mysqli_error($db));
  if ($result) {
      while($row = mysqli_fetch_array($result)) {
          echo $row['id'] . " " . $row['username'] . "\n<br>";
      }
  }
## END #2
  
echo "done";
?>

