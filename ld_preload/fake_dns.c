#define _GNU_SOURCE
#include <stdio.h>
#include <netdb.h>
#include <dlfcn.h>
#include <stdlib.h>
#include <string.h>

typedef struct hostent * (*org_gethostbyname)(const char *pathname);


struct hostent *gethostbyname(const char *name) {
    printf("We are in our fake module with %s\n", name);

    // variant A: call original gethostbyname and overwrite ip
    /*
	struct hostent *he;
    org_gethostbyname org_gethost;
    org_gethost = (org_gethostbyname)dlsym(RTLD_NEXT,"gethostbyname");

    he = org_gethost("heise.de");
    //he->h_addr_list[0] = "4c79b804";
    he->h_addr_list[0] = "1";
    return he;
    */

    // variant B: just respond with an ip
    // todo: use inet_aton instead
    FILE *file_addr;
    char *input_buffer = malloc(100);
    struct hostent *he; 
    
    memset(input_buffer, 0, 100);
    file_addr = fopen("address.txt", "r");  
    if (file_addr == NULL) {
        printf("file not found\n");
        exit(0);
    }
    fgets(input_buffer, 100, file_addr);
    printf("Read: %s\n", input_buffer);
    fclose(file_addr);
    
    char *list_ips[] = { input_buffer, 0 };
    he = malloc (sizeof (struct hostent));
    he->h_addr_list = list_ips;
    return he;
}

int rand() {
    return 42;
}
